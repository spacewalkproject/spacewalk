<datasource_modes>

<callable-mode name="update_channel">
  <query params="cid">
    {call rhn_channel.update_channel(:cid)}
  </query>
</callable-mode>

<mode name="system_latest_all_available_packages">
  <query params="sid">
SELECT
        pn.name AS name,
        full_list.id AS id,
        NVL(full_list.evr.version, ' ') AS version,
        NVL(full_list.evr.release, ' ') AS release,
        NVL(full_list.evr.epoch, ' ') AS epoch,
        NVL(full_list.arch_label, ' ') AS arch_label
  FROM  (
         SELECT  p.name_id name_id,
                 p.id,
                 p.evr_id,
                 max(pe.evr) evr,
                 pa.label as arch_label
           FROM  rhnPackageArch PA, rhnPackageEVR PE, rhnPackage P,
                 rhnChannelNewestPackage CNP, rhnServerChannel SC
          WHERE  sc.server_id = :sid
            AND  sc.channel_id = cnp.channel_id
            AND  cnp.package_id = p.id
            AND  p.evr_id = pe.id
            AND  p.package_arch_id = pa.id
       GROUP BY  p.name_id, p.id, p.evr_id, pa.label
       ) full_list,
       rhnPackageName pn
 WHERE  full_list.name_id = pn.id
   AND  NOT EXISTS (SELECT 1
                      FROM rhnServerPackage SP, rhnPackageEVR PE2
                     WHERE SP.server_id = :sid
                       AND SP.name_id = full_list.name_id
                       AND SP.evr_id = PE2.id
                       AND PE2.evr &gt;= full_list.evr)
ORDER BY  UPPER(pn.name), full_list.evr
  </query>
</mode>

<mode name="package_conflicts">
  <query params="pid">
SELECT  DISTINCT C.name, C.version, P.sense
  FROM  rhnPackageCapability C, rhnPackageConflicts P
 WHERE  P.package_id = :pid
   AND  P.capability_id = C.id
ORDER BY UPPER(C.name), C.version
  </query>
</mode>

<mode name="package_provides">
  <query params="pid">
SELECT  DISTINCT C.name, C.version, P.sense
  FROM  rhnPackageCapability C, rhnPackageProvides P
 WHERE  P.package_id = :pid
   AND  P.capability_id = C.id
ORDER BY UPPER(C.name), C.version
  </query>
</mode>

<mode name="package_obsoletes">
  <query params="pid">
SELECT  DISTINCT C.name, C.version, P.sense
  FROM  rhnPackageCapability C, rhnPackageObsoletes P
 WHERE  P.package_id = :pid
   AND  P.capability_id = C.id
ORDER BY UPPER(C.name), C.version
  </query>
</mode>

<mode name="package_requires">
  <query params="pid">
SELECT  DISTINCT C.name, C.version, P.sense
  FROM  rhnPackageCapability C, rhnPackageRequires P
 WHERE  P.package_id = :pid
   AND  P.capability_id = C.id
ORDER BY UPPER(C.name), C.version
  </query>
</mode>

<mode name="package_files">
  <query params="pid">
SELECT C.name,
       F.file_size,
       CS.checksum,
       CS.checksum_type checksumtype,
       F.file_mode,
       F.linkto,
       TO_CHAR(F.mtime, 'YYYY-MM-DD HH24:MI:SS') AS MTIME
  FROM rhnPackageFile F, rhnPackageCapability C,
       rhnChecksumView CS
 WHERE F.package_id = :pid
   AND F.capability_id = C.id
   AND F.checksum_id = CS.id
ORDER BY UPPER(C.name)
  </query>
</mode>

<write-mode name="cleanup_package_requires">
  <query params="pid">
    DELETE from
    rhnPackageRequires r
    WHERE r.package_id = :pid
  </query>
</write-mode>

<write-mode name="cleanup_package_provides">
  <query params="pid">
    DELETE FROM
    rhnPackageProvides p
    WHERE p.package_id = :pid
  </query>
</write-mode>

<write-mode name="cleanup_package_conflicts">
  <query params="pid">
    DELETE from
    rhnPackageConflicts
    where package_id = :pid
  </query>
</write-mode>

<write-mode name="cleanup_package_obsoletes">
  <query params="pid">
    DELETE from
    rhnPackageObsoletes
    where package_id = :pid
  </query>
</write-mode>

<write-mode name="cleanup_package_caps">
  <query params="pid">
DELETE FROM
rhnPackageCapability
WHERE id IN
  (SELECT C.id FROM rhnPackageCapability C, rhnPackageFile F
   WHERE F.package_id = :pid
   AND F.capability_id = C.id)
  </query>
</write-mode>

<write-mode name="cleanup_package_files">
  <query params="pid">
    DELETE FROM
    rhnPackageFile F
    WHERE F.package_id = :pid
  </query>
</write-mode>

<write-mode name="cleanup_package_changelogs">
  <query params="pid">
    DELETE from
    rhnPackageChangelog
    where package_id = :pid
  </query>
</write-mode>

<write-mode name="cleanup_package_channels">
  <query params="pid">
    DELETE from
    rhnChannelPackage
    where package_id = :pid
  </query>
</write-mode>

<!-- Deletes references from a channel to a package for all packages in the given RhnSet.
     The set must contain the package ID in the "element" of the set. -->
<write-mode name="cleanup_package_channels_from_set">
  <query params="set_label">
    DELETE FROM rhnChannelPackage
          WHERE package_id IN (
                SELECT s.element
                  FROM rhnSet s
                 WHERE s.label = :set_label
                )
  </query>
</write-mode>


<mode name="providing_channels">
  <query params="pid, org_id">
SELECT  C.id, C.name, C.label
  FROM  rhnAvailableChannels AC, rhnChannel C, rhnChannelPackage CP
 WHERE  CP.package_id = :pid
   AND  CP.channel_id = C.id
   AND  AC.org_id = :org_id
   AND  C.id = AC.channel_id
ORDER BY UPPER(C.label)
  </query>
</mode>

<mode name="name_by_provide" class="com.redhat.rhn.frontend.dto.PackageListItem">
  <query params="org_id, cap_name">
SELECT DISTINCT PN.name
 FROM rhnPackageName PN,
      rhnPackage P,
      rhnPackageProvides PP,
      rhnPackageCapability PC
WHERE PC.name = :cap_name
  AND PC.id = PP.capability_id
  AND PP.package_id = P.id
  AND (P.org_id = :org_id OR EXISTS (
          SELECT  1
            FROM  rhnChannelPackage CP,
                  rhnChannelFamilyMembers CFM,
                  rhnOrgChannelFamilyPermissions CFP
           WHERE  CFP.org_id = :org_id
             AND  CFP.channel_family_id = CFM.channel_family_id
             AND  CFM.CHANNEL_ID = CP.channel_id
             AND  CP.package_id = P.id))
  AND P.name_id = PN.id
ORDER BY UPPER(PN.name)
  </query>
</mode>

<mode name="name_by_provide_and_channel" class="com.redhat.rhn.frontend.dto.PackageListItem">
  <query params="channel_id, org_id, cap_name">
SELECT DISTINCT PN.name

 FROM rhnPackageName PN,
      rhnPackage P,
      rhnPackageProvides PP,
      rhnPackageCapability PC
WHERE PC.name = :cap_name
  AND PC.id = PP.capability_id
  AND PP.package_id = P.id
  AND (
    (P.org_id = :org_id AND EXISTS (
        SELECT 1
        FROM rhnChannelPackage CP
            WHERE CP.channel_id = :channel_id
                AND CP.package_id = P.id))
    OR EXISTS (
          SELECT  1
            FROM  rhnChannelPackage CP,
                  rhnChannelFamilyMembers CFM,
                  rhnOrgChannelFamilyPermissions CFP
           WHERE  CFP.org_id = :org_id
             AND  CP.channel_id = :channel_id
             AND  CFP.channel_family_id = CFM.channel_family_id
             AND  CFM.CHANNEL_ID = CP.channel_id
             AND  CP.package_id = P.id))
  AND P.name_id = PN.id
ORDER BY UPPER(PN.name)
  </query>
</mode>

<mode name="packages_in_errata" class="com.redhat.rhn.frontend.dto.PackageOverview">
  <query params="eid">
SELECT DISTINCT P.id id, PN.name || '-' || PE.version
       || '-' || PE.release || (CASE WHEN PE.epoch IS NULL THEN '' ELSE ':' || PE.epoch END)
       || '-' || PA.label package_nvre
 FROM rhnPackageName PN,
      rhnPackageEVR PE,
      rhnPackageArch PA,
      rhnPackage P,
      rhnErrataPackage EP
WHERE EP.errata_id = :eid
  AND EP.package_id = P.id
  AND PN.id = P.name_id
  AND PE.id = P.evr_id
  AND PA.id = P.package_arch_id
ORDER BY UPPER(PN.name || '-' || PE.version || '-' || PE.release || (CASE WHEN PE.epoch IS NULL THEN '' ELSE ':' || PE.epoch END)  || '-' || PA.label)
  </query>
  <elaborator name="package_channels" />
</mode>

<mode name="packages_in_tmp_errata" class="com.redhat.rhn.frontend.dto.PackageOverview">
  <query params="eid">
SELECT DISTINCT P.id id, PN.name || '-' || PE.version
       || '-' || PE.release || (CASE WHEN PE.epoch IS NULL THEN '' ELSE ':' || PE.epoch END)
       || '-' || PA.label package_nvre
 FROM rhnPackageName PN,
      rhnPackageEVR PE,
      rhnPackageArch PA,
      rhnPackage P,
      rhnErrataPackageTmp EP
WHERE EP.errata_id = :eid
  AND EP.package_id = P.id
  AND PN.id = P.name_id
  AND PE.id = P.evr_id
  AND PA.id = P.package_arch_id
ORDER BY UPPER(PN.name || '-' || PE.version || '-' || PE.release || (CASE WHEN PE.epoch IS NULL THEN '' ELSE ':' || PE.epoch END)  || '-' || PA.label)
  </query>
  <elaborator name="package_channels" />
</mode>

<mode name="packages_in_channel_by_id_combo" class="com.redhat.rhn.frontend.dto.PackageListItem">
  <query params="cid">
SELECT PN.id || '|' || PE.id || '|' || PA.id AS ID_COMBO,
       PN.name,
       PN.name || '-' || PE.evr.as_vre_simple() AS NVRE,
       P.summary,
       PA.id AS arch_id,
       PE.epoch,
       PE.version,
       PE.release,
       PN.name || '-' || PE.evr.as_vre_simple() || '.' || PA.label AS NVREA,
       PN.id as name_id,
       PE.id as evr_id
  FROM rhnPackageArch PA, rhnPackageName PN, rhnPackageEVR PE, rhnPackage P,
       rhnChannelPackage CP
 WHERE CP.channel_id = :cid
   AND CP.package_id = P.id
   AND P.name_id = PN.id
   AND P.evr_id = PE.id
   AND PA.id = P.package_arch_id
ORDER BY UPPER(NVRE)
  </query>
</mode>

<mode name="packages_in_channel" class="com.redhat.rhn.frontend.dto.PackageOverview">
  <query params="cid">
SELECT P.id AS ID,
       PN.name as package_name,
       P.summary,
       PN.name || '-' || PE.evr.as_vre_simple() || '.' || PA.label AS nvrea,
       PP.name AS provider
  FROM rhnPackage P inner join
  	   rhnPackageArch PA on P.package_arch_id = PA.id inner join
       rhnPackageName PN on P.name_id = PN.id inner join
       rhnPackageEVR PE on P.evr_id = PE.id  inner join
       rhnChannelPackage CP on P.id = CP.package_id left join
       rhnPackageKeyAssociation assoc on assoc.package_id = P.id left join
       rhnPackageKey KEY on KEY.id = assoc.key_id left join
       rhnPackageProvider PP on key.provider_id = PP.id  left join
       rhnPackageKeyType KEYT on KEY.key_type_id = KEYT.id
 WHERE CP.channel_id = :cid and
		( KEYT.label = 'gpg' or KEYT.label is NULL)
  </query>
</mode>

<!-- used by ChannelSoftwareHandler -->
<mode name="latest_packages_in_channel_api">
    <query params="cid">
SELECT DISTINCT
                CNP.package_id as id,
                PN.name as name,
                NVL(PE.version, ' ') as version,
                NVL(PE.release, ' ') as release,
                NVL(PE.epoch, ' ') as epoch,
                NVL(PA.label, ' ') AS arch_label
  FROM rhnPackageName PN,
       rhnPackageEVR PE,
       rhnPackageArch PA,
       rhnChannelNewestPackage CNP,
       rhnChannel C
 WHERE C.id = :cid
   AND C.id = CNP.channel_id
   AND PN.id = CNP.name_id
   AND PE.id = CNP.evr_id
   AND PA.id = CNP.package_arch_id
ORDER BY UPPER(PN.name)
</query>
</mode>

<mode name="latest_packages_in_channel" class="com.redhat.rhn.frontend.dto.PackageListItem">
  <query params="cid">
<!-- must call the id_combo simply 'id' because listview assumes that
     will be the name -->

SELECT DISTINCT
       PN.name || '-' || PE.evr.as_vre_simple() AS nvre,
       PN.id || '|' || CNP.evr_id || '|' || PA.id AS id_combo,
       (SELECT MAX(summary) FROM rhnPackage P WHERE P.id = CNP.package_id) SUMMARY,
       PA.label as arch
  FROM rhnPackageName PN,
       rhnPackageEVR PE,
       rhnPackageArch PA,
       rhnChannelNewestPackage CNP
 WHERE CNP.channel_id = :cid
   AND PN.id = CNP.name_id
   AND PE.id = CNP.evr_id
   AND PA.id = CNP.PACKAGE_ARCH_ID
ORDER BY UPPER(NVRE)
  </query>
</mode>

<mode name="system_package_list" class="com.redhat.rhn.frontend.dto.PackageListItem">
  <query params="sid">
SELECT  PN.id || '|' || PE.id || '|' || PA.id AS ID_COMBO,
        PN.name || '-' || PE.evr.as_vre_simple() AS NVRE,
        PN.name || '-' || PE.evr.as_vre_simple() || '.' || PA.label AS NVREA,
        PN.name AS name,
        PE.version,
        PE.release,
        PE.epoch,
        PN.id AS NAME_ID,
        PE.id AS EVR_ID,
        PA.label as arch,
        SP.installtime as installTime
  FROM  rhnPackageName PN
  			INNER JOIN rhnServerPackage SP on SP.name_id = PN.id
  			INNER JOIN rhnPackageEVR PE on SP.evr_id = PE.id
  			LEFT JOIN rhnPackageArch PA on SP.PACKAGE_ARCH_ID  = PA.id
  WHERE  SP.server_id = :sid
ORDER BY UPPER(NVRE)
  </query>
</mode>

<mode name="system_canonical_package_list" class="com.redhat.rhn.frontend.dto.PackageListItem">
  <query params="sid, org_id">
SELECT PN.id || '|' || SPE.id AS ID_COMBO,
       SP.name_id,
       PN.name,
       SP.evr_id,
       SP.package_arch_id AS ARCH_ID,
       PA.label AS ARCH,
       SPE.evr.as_vre_simple() AS EVR,
       SPE.evr.as_vre_simple() || (CASE WHEN SP.package_arch_id IS NULL THEN '' ELSE '.' || PA.label END) AS EVRA,
       SPE.epoch,
       SPE.version,
       SPE.release
  FROM rhnServerPackage SP LEFT OUTER JOIN
       rhnPackageArch PA ON SP.package_arch_id = PA.id INNER JOIN
       rhnPackageName PN ON SP.name_id = PN.id INNER JOIN
       rhnPackageEVR SPE ON SP.evr_id = SPE.id
 WHERE SP.server_id = :sid
   AND NOT EXISTS (SELECT 1 FROM rhnPackageSyncBlacklist PSB WHERE
                     PSB.package_name_id = PN.id AND org_id is NULL OR org_id = :org_id)
  </query>
</mode>

<mode name="profile_canonical_package_list" class="com.redhat.rhn.frontend.dto.PackageListItem">
  <query params="prid,org_id">
  SELECT PN.id || '|' || SPE.id AS ID_COMBO,
       SP.name_id,
       PN.name,
       SP.evr_id,
       SP.package_arch_id AS ARCH_ID,
       PA.label AS ARCH,
       SPE.evr.as_vre_simple() AS EVR,
       SPE.evr.as_vre_simple() || '.' || PA.label AS NVREA,
       SPE.evr.as_vre_simple() || (CASE WHEN SP.package_arch_id IS NULL THEN '' ELSE '.' || PA.label END) AS EVRA,
       SPE.epoch,
       SPE.version,
       SPE.release
  FROM rhnServerProfilePackage SP LEFT OUTER JOIN
       rhnPackageArch PA ON SP.package_arch_id = PA.id INNER JOIN
       rhnPackageName PN ON SP.name_id = PN.id INNER JOIN
       rhnPackageEVR SPE ON SP.evr_id = SPE.id
 WHERE SP.server_profile_id = :prid
   AND NOT EXISTS (SELECT 1 FROM rhnPackageSyncBlacklist PSB WHERE
                     PSB.package_name_id = PN.id AND org_id is NULL OR org_id = :org_id)
  </query>
</mode>

<mode name="packages_from_server_set" class="com.redhat.rhn.frontend.dto.SsmRemovePackageListItem">
  <query params="user_id, set_label">
SELECT   PN.ID || '|' || PE.ID || '|' || X.package_arch_id AS id_combo,
         PN.name || '-' || PE.evr.as_vre_simple() AS nvre,
         PA.label AS arch,
         X.num_systems AS num_systems
    FROM rhnPackageName PN,
         rhnPackageEVR PE,
         rhnPackageArch PA,
         (SELECT   SP.name_id,
                   SP.evr_id,
                   SP.package_arch_id,
                   COUNT (SP.server_id) num_systems
              FROM rhnServerPackage SP,
                   rhnSet S
             WHERE s.user_id = :user_id
               AND s.label = :set_label
               AND s.ELEMENT = SP.server_id
          GROUP BY SP.name_id,
                   SP.evr_id,
                   SP.package_arch_id) X
   WHERE PE.ID = X.evr_id
     AND PN.ID = X.name_id
     AND PA.ID (+) = X.package_arch_id
ORDER BY UPPER (PN.NAME)
  </query>
</mode>

<mode name="packages_in_set"  class="com.redhat.rhn.frontend.dto.PackageListItem">
  <query params="set_label, user_id">
  SELECT  PN.id || '|' || PE.id AS ID_COMBO, PN.name || '-' || PE.evr.as_vre_simple() AS NVRE
    FROM  rhnPackageName PN, rhnPackageEVR PE, rhnSet S
   WHERE  S.label = :set_label
     AND  S.user_id = :user_id
     AND  S.element = PN.id
     AND  S.element_two = PE.id
ORDER BY  UPPER(NVRE)
  </query>
</mode>

<mode name="package_ids_in_set" class="com.redhat.rhn.frontend.dto.PackageOverview">
  <query params="set_label, user_id">
  SELECT  P.id AS ID, PN.name || '-' || PE.evr.as_vre_simple() || '.' || PA.label AS NVREA
    FROM  rhnPackage P,
          rhnPackageName PN,
          rhnPackageEVR PE,
          rhnPackageArch PA,
          rhnSet S
   WHERE  S.label = :set_label
     AND  S.user_id = :user_id
     AND  S.element = P.id
     AND  P.name_id = PN.id
     AND  P.evr_id = PE.id
     AND  PA.id = P.package_arch_id
ORDER BY  UPPER(NVREA)
  </query>
  <elaborator name="package_details" />
  <elaborator name="package_channels" />
</mode>

<mode name="packages_available_to_errata" class="com.redhat.rhn.frontend.dto.PackageOverview">
  <query params="org_id, eid">
SELECT DISTINCT P.id id, PN.name || '-' || PE.version
           || '-' || PE.release || (CASE WHEN PE.epoch IS NULL THEN '' ELSE ':' || PE.epoch END)
           || '-' || PA.label PACKAGE_NVRE
    FROM rhnPackageName PN,
         rhnPackageEVR PE,
         rhnPackageArch PA,
       rhnArchType PAT,
         rhnPackage P
   WHERE P.org_id = :org_id
     AND PN.id = P.name_id
     AND PE.id = P.evr_id
     AND PA.id = P.package_arch_id
     AND PA.arch_type_id = PAT.id
   AND PAT.label = 'rpm'
     AND NOT EXISTS (SELECT 1
                       FROM rhnErrataPackage EP
                      WHERE EP.errata_id = :eid
                        AND EP.package_id = P.id)
ORDER BY UPPER(PACKAGE_NVRE)
  </query>
  <elaborator name="package_channels" />
</mode>

<mode name="packages_available_to_tmp_errata"  class="com.redhat.rhn.frontend.dto.PackageOverview">
  <query params="org_id, eid">
  SELECT DISTINCT P.id ID,
                  PN.name || '-' || PE.version || '-' || PE.release
                    || (CASE WHEN PE.epoch IS NULL THEN '' ELSE ':' || PE.epoch END)
                    || '-' || PA.label PACKAGE_NVRE
    FROM rhnPackageName PN,
         rhnPackageEVR PE,
         rhnPackageArch PA,
     rhnArchType PAT,
         rhnPackage P
   WHERE P.org_id = :org_id
     AND PN.id = P.name_id
     AND PE.id = P.evr_id
     AND PA.id = P.package_arch_id
   AND PA.arch_type_id = PAT.id
   AND PAT.label = 'rpm'
     AND NOT EXISTS (SELECT 1
                       FROM rhnErrataPackageTmp EP
                      WHERE EP.errata_id = :eid
                        AND EP.package_id = P.id)
ORDER BY UPPER(PACKAGE_NVRE)
  </query>
  <elaborator name="package_channels" />
</mode>

<mode name="packages_available_to_errata_in_channel" class="com.redhat.rhn.frontend.dto.PackageOverview">
  <query params="source_cid, target_eid">
SELECT P.id AS ID,
       PN.name || '-' || PE.evr.as_vre_simple() AS PACKAGE_NVRE,
       P.summary
  FROM rhnPackageName PN, rhnPackageEVR PE, rhnPackage P,
       rhnChannelPackage CP
 WHERE CP.channel_id = :source_cid
   AND CP.package_id = P.id
   AND P.name_id = PN.id
   AND P.evr_id = PE.id
   AND NOT EXISTS (SELECT 1
              FROM rhnErrataPackage EP
             WHERE EP.errata_id = :target_eid
               AND EP.package_id = P.id)
ORDER BY UPPER(PACKAGE_NVRE)
  </query>
  <elaborator name="package_channels" />
</mode>

<mode name="packages_available_to_tmp_errata_in_channel" class="com.redhat.rhn.frontend.dto.PackageOverview">
  <query params="source_cid, target_eid">
SELECT P.id AS ID,
       PN.name || '-' || PE.evr.as_vre_simple() AS PACKAGE_NVRE,
       P.summary
  FROM rhnPackageName PN, rhnPackageEVR PE, rhnPackage P,
       rhnChannelPackage CP
 WHERE CP.channel_id = :source_cid
   AND CP.package_id = P.id
   AND P.name_id = PN.id
   AND P.evr_id = PE.id
   AND NOT EXISTS (SELECT 1
              FROM rhnErrataPackagetmp EP
             WHERE EP.errata_id = :target_eid
               AND EP.package_id = P.id)
ORDER BY UPPER(PACKAGE_NVRE)
  </query>
  <elaborator name="package_channels" />
</mode>

<query name="package_channels" params="org_id"
     multiple="t"
     class="com.redhat.rhn.frontend.dto.PackageOverview">
SELECT CP.package_id id, C.name package_channels
  FROM rhnChannel C, rhnChannelPackage CP
 WHERE CP.package_id IN(%s)
   AND C.id = CP.channel_id
   AND (EXISTS (SELECT 1
                  FROM rhnChannelFamilyPermissions CFP,
                       rhnChannelFamilyMembers CFM
                 WHERE CFP.org_id = :org_id
                   AND CFM.channel_family_id = CFP.channel_family_id
                   AND CFM.channel_id = C.id)
       OR C.org_id is NULL)
</query>

<query name="package_details" params="">
SELECT P.id, P.summary, PP.name as provider
  FROM rhnPackage P left join
       rhnPackageKeyAssociation assoc on assoc.package_id = P.id left join
       rhnPackageKey KEY on KEY.id = assoc.key_id left join
       rhnPackageProvider PP on key.provider_id = PP.id  left join
       rhnPackageKeyType KEYT on KEY.key_type_id = KEYT.id
 WHERE ( KEYT.label = 'gpg' or KEYT.label is NULL)   and
		 P.id IN(%s)
</query>


<mode name="system_available_packages"  class="com.redhat.rhn.frontend.dto.PackageListItem">
  <query params="sid">
SELECT  distinct pn.name AS NAME,
        pn.name || '-' || full_list.evr.version || '-' || full_list.evr.release || DECODE(full_list.evr.epoch, NULL, '', ':' || full_list.evr.epoch) AS NVRE,
        pn.name || '-' || full_list.evr.version || '-' || full_list.evr.release || DECODE(full_list.evr.epoch, NULL, '', ':' || full_list.evr.epoch) || '.' || full_list.arch_label AS NVREA,
        pn.id || '|' || lookup_evr(full_list.evr.epoch, full_list.evr.version, full_list.evr.release) || '|' || full_list.arch_id AS ID_COMBO,
        full_list.arch_label as ARCH
  FROM  (
         SELECT  p.name_id name_id, max(pe.evr) evr,
                 pa.label as arch_label, pa.id as arch_id
           FROM  rhnPackageEVR PE, rhnPackage P,
                 rhnChannelPackage CP, rhnServerChannel SC,
                 rhnPackageArch PA
          WHERE  sc.server_id = :sid
            AND  sc.channel_id = cp.channel_id
            AND  cp.package_id = p.id
            AND  p.evr_id = pe.id
            AND  p.package_arch_id = pa.id
       GROUP BY  p.name_id, pa.label, pa.id
       ) full_list,
       rhnPackageName pn
     INNER JOIN rhnPackage PKG ON pkg.name_id = pn.id
 WHERE  full_list.name_id = pn.id
   AND  NOT EXISTS (SELECT 1
                      FROM rhnServerPackage SP
                     WHERE SP.server_id = :sid
                       AND SP.name_id = full_list.name_id
                       AND (SP.package_arch_id = full_list.arch_id or SP.package_arch_id is null))
ORDER BY  UPPER(pn.name)
  </query>
</mode>


<mode name="lookup_id_combo_by_name">
<query params="sid, name">
SELECT  pn.id as name_id, lookup_evr(full_list.evr.epoch, full_list.evr.version, full_list.evr.release) AS evr_id
  FROM  (
         SELECT  p.name_id name_id, max(pe.evr) evr
           FROM  rhnPackageEVR PE, rhnPackage P,
                 rhnChannelPackage CP, rhnServerChannel SC
          WHERE  sc.server_id = :sid
            AND  sc.channel_id = cp.channel_id
            AND  cp.package_id = p.id
            AND  p.evr_id = pe.id
       GROUP BY  p.name_id
       ) full_list,
       rhnPackageName pn
 WHERE  full_list.name_id = pn.id
   AND  pn.name = :name
  </query>
</mode>

<mode name="ssm_packages_for_upgrade" class="com.redhat.rhn.frontend.dto.SsmUpgradablePackageListItem">
  <query params="user_id">
SELECT  P.id AS ID,
        PN.id || '|' || PE.id || '|' || PA.id AS ID_COMBO,
        PE.version AS VERSION,
        PE.release AS RELEASE,
        PE.epoch AS EPOCH,
        PN.name AS NAME,
        PA.label AS ARCH,
        E.advisory_type,
        E.advisory,
        E.id AS ADVISORY_ID,
        COUNT(DISTINCT SNPC.server_id) NUM_SYSTEMS
  FROM  rhnErrata E,
        rhnPackageEVR PE,
        rhnPackageName PN,
        rhnPackage P,
        rhnPackageArch PA,
        rhnServerNeededPackageCache SNPC,
        rhnSet S
 WHERE  S.user_id = :user_id
   AND  S.label = 'system_list'
   AND  S.element = SNPC.server_id
   AND  SNPC.package_id = P.id
   AND  P.name_id = PN.id
   AND  P.evr_id = PE.id
   AND  P.package_arch_id = PA.id
   AND  SNPC.errata_id = E.id (+)
GROUP BY P.id,
         PN.name,
         PE.version,
         PE.release,
         PE.epoch,
         PA.label,
         PA.id,
         PN.id,
         PE.id,
         E.advisory_type,
         E.advisory,
         E.id
ORDER BY UPPER(PN.name), UPPER(PE.version), UPPER(PE.release), UPPER(PE.epoch)
  </query>
</mode>

<mode name="count_system_upgradable_package_list">
  <query params="sid">
SELECT  COUNT(pn.id) AS COUNT
  FROM  rhnPackageName PN,
        (
         SELECT  SOP.package_name_id AS name_id, MAX(PE.evr) evr
           FROM  rhnPackageEVR PE, rhnServerOutdatedPackages SOP
          WHERE  SOP.server_id = :sid
            AND  SOP.package_evr_id = PE.id
       GROUP BY  SOP.package_name_id
         ) full_list
 WHERE  full_list.name_id = PN.id
ORDER BY  UPPER(PN.name)
  </query>
</mode>

<mode name="system_upgradable_package_list" class="com.redhat.rhn.frontend.dto.UpgradablePackageListItem">
  <query params="sid">
SELECT  PN.id AS id,
        PN.id AS name_id,
        lookup_evr(latest.evr.epoch, latest.evr.version, latest.evr.release) AS evr_id,
        latest.arch_id AS arch_id,
        latest.evr.epoch AS epoch,
        latest.evr.version AS version,
        latest.evr.release AS release,
        PN.name AS name,
        PN.name ||'-'|| latest.evr.version || '-' || latest.evr.release || DECODE(latest.evr.epoch, NULL, '', ':' || latest.evr.epoch) || (CASE WHEN latest.arch_id IS NULL THEN '' ELSE '.' || latest.arch_label END) AS nvrea,
        PN.name || '-' || PE.evr.as_vre_simple() || (CASE WHEN SP.package_arch_id IS NULL THEN '' ELSE '.' || PA.label END) AS installed_package,
        PN.id || '|' || lookup_evr(latest.evr.epoch, latest.evr.version, latest.evr.release)|| '|' || latest.arch_id AS id_combo
  FROM  rhnPackageName PN,
        rhnServerPackage SP
        INNER JOIN rhnPackageEVR PE on SP.evr_id = PE.id
        LEFT JOIN rhnPackageArch PA on SP.package_arch_id = PA.id,
        (
         SELECT  P.name_id AS name_id, MAX(PE.evr) evr,
                 P.package_arch_id as arch_id, PA.label as arch_label
          FROM   rhnServerNeededCache SNC inner join
                 rhnPackage P on SNC.package_Id = P.id inner join
                 rhnPackageEVR PE on P.evr_id = PE.id inner join
                 rhnPackageArch PA on PA.id = P.package_arch_id
          WHERE  SNC.server_id = :sid
       GROUP BY  P.name_id, P.package_arch_id, PA.label
       ) latest
 WHERE  latest.name_id = PN.id
   AND  SP.server_id = :sid
   AND  SP.name_id = PN.id
   AND  (SP.package_arch_id IS NULL OR SP.package_arch_id =
                 -- If the server has more than one package of this name installed
                 -- Then group by arch, otherwise just use whever is there
   	             NVL2(
                     (select 1 from rhnServerPackage sp2
                               where
                               sp2.name_id = latest.name_id and
                                sp2.server_id = :sid
                                group by sp2.name_id having count(*) > 1
                        ),
                        latest.arch_id,
                        SP.package_arch_id)

   	)
ORDER BY  UPPER(PN.name)
  </query>
  <elaborator multiple="t" params="sid">
  SELECT  PN.id AS id,
          SOP.errata_id AS errata_id,
          SOP.errata_advisory AS errata_advisory,
          E.advisory_type AS errata_advisory_type
    FROM  rhnServerOutdatedPackages SOP
          INNER JOIN rhnPackageName PN on SOP.package_name_id = PN.id
          INNER JOIN rhnErrata E on SOP.errata_id = E.id
   WHERE  PN.id IN (%s)
     AND  SOP.server_id = :sid
  </elaborator>
</mode>

<mode name="system_upgradable_package_list_no_errata_info">
  <query params="sid">
SELECT  PN.name,
        NVL(PE.epoch, ' ') as FROM_EPOCH,
        NVL(PE.version, ' ') as FROM_VERSION,
        NVL(PE.release, ' ') as FROM_RELEASE,
        NVL(full_list.evr.epoch, ' ') as TO_EPOCH,
        NVL(full_list.evr.version, ' ') as TO_VERSION,
        NVL(full_list.evr.release, ' ') as TO_RELEASE,
        full_list.arch_label as ARCH,
        P.id as TO_PACKAGE_ID
  FROM  (
         SELECT  SOP.package_name_id name_id,
                 MAX(PE.evr) evr,
                 PE.id evr_id,
                 SP.package_arch_id,
                 PA.label as arch_label
           FROM  rhnServerOutdatedPackages SOP
                 INNER JOIN rhnServerPackage SP ON SP.server_id = SOP.server_id
                 INNER JOIN rhnPackageEVR PE ON SOP.package_evr_id = PE.id
                 LEFT JOIN rhnPackageArch PA ON PA.id = SP.package_arch_id
          WHERE  SOP.server_id = :sid
            AND  SOP.package_name_id = SP.name_id
        GROUP BY SOP.package_name_id, SP.package_arch_id, PA.label, PE.id
        ) full_list
        INNER JOIN rhnServerPackage SP ON ( full_list.name_id = SP.name_id AND full_list.package_arch_id = SP.package_arch_id )
        INNER JOIN rhnPackageName PN ON ( PN.id = full_list.name_id )
        INNER JOIN rhnPackageEVR PE ON ( SP.evr_id = PE.id )
        INNER JOIN rhnPackage P on ( P.name_id = full_list.name_id AND P.evr_id = full_list.evr_id AND P.package_arch_id = full_list.package_arch_id )
 WHERE  SP.server_id = :sid
  </query>
</mode>

<mode name="package_download_for_system_arch_select" class="com.redhat.rhn.frontend.dto.PackageListItem">
  <query params="set_label, user_id, sid">
SELECT P.id, PN.name || '-' || PEVR.evr.as_vre_simple() as NVRE,
  PA.label as ARCH, P.path
  FROM rhnPackage P,
       rhnPackageName PN,
       rhnPackageEVR PEVR,
       rhnPackageArch PA,
       rhnSet S
 WHERE S.label = :set_label
   AND S.user_id = :user_id
   AND PN.id = S.element
   AND PEVR.id = S.element_two
   AND P.name_id = PN.id
   AND P.evr_id = PEVR.id
   AND P.package_arch_id = PA.id
   AND EXISTS (SELECT 1 FROM rhnServerNeededPackageCache SNPC WHERE SNPC.server_id = :sid AND SNPC.package_id = P.id)
  </query>
  <elaborator multiple="t" params="sid">
SELECT CP.package_id as ID,
       C.name as CHANNEL_NAME,
       C.id as CHANNEL_ID
  FROM rhnServerChannel SC, rhnChannelPackage CP, rhnChannel C
 WHERE CP.package_id in (%s)
   AND C.id = CP.channel_id
   AND SC.server_id = :sid
   AND SC.channel_id = C.id
  </elaborator>
</mode>


<mode name="packages_associated_with_action">
  <query params="aid">
SELECT  DISTINCT PN.id || '|' || PE.id AS ID, PN.name || '-' || PE.evr.as_vre_simple() AS NVRE
  FROM  rhnPackageName PN,
        rhnPackageEVR PE,
        rhnActionPackage AP
 WHERE  AP.action_id = :aid
   AND  PN.id = AP.name_id
   AND  PE.id = AP.evr_id
ORDER BY  UPPER(NVRE)
  </query>
</mode>

<callable-mode name="lookup_evr">
    <query params="epoch, version, release">
        {:evrId = call lookup_evr(:epoch, :version, :release)}
    </query>
</callable-mode>

<mode name="compatible_package_arches">
  <query>
SELECT DISTINCT pa.label, pa.name
  FROM rhnPackageArch pa,
       rhnChannelPackageArchCompat cpac,
       rhnChannelArch ca
 WHERE pa.id = cpac.package_arch_id
   AND cpac.channel_arch_id = ca.id
   AND ca.label
    IN (%s)
  </query>
</mode>

<mode name="system_patch_list" class="com.redhat.rhn.frontend.dto.PackageListItem">
  <query params="sid">
SELECT PN.id as ID,
       PN.id || '|' || PE.id AS ID_COMBO,
      PN.name || '-' || PE.evr.as_vre_simple() AS NVRE,
      PN.name AS name,
      PE.version,
      PE.release,
      PE.epoch,
      PN.id AS NAME_ID,
      PE.id AS EVR_ID,
        nvl( (select spt.name                 from rhnSolarisPatchType spt,
                   rhnSolarisPatch RSP,
                         rhnPackage p
             where RSP.package_id = p.id
         and P.name_id = SP.name_id
               and P.evr_id = SP.evr_id
               and P.package_arch_id = SP.package_arch_id
               and RSP.patch_type = spt.id),
               'unknown') as PATCH_TYPE
FROM  rhnPackageName PN,
        rhnPackageEVR PE,
        rhnServerPackage SP
WHERE SP.server_id = :sid
 AND  SP.name_id = PN.id
 AND  SP.evr_id = PE.id
 AND  EXISTS ( SELECT  1
                 FROM  rhnPackageArch PA,
                       rhnArchType AT
                WHERE  PA.id = SP.package_arch_id
                  AND  AT.id = PA.arch_type_id
                  AND  AT.label = 'solaris-patch' )
ORDER BY UPPER(NVRE)
  </query>
  <elaborator params="sid" multiple="t">
      SELECT PN.id,
             TO_CHAR(SA.completion_time, 'YYYY-MM-DD HH:MI:SS') AS TIMESTAMP,
             ACS.name AS ACTION_STATUS
      FROM   rhnActionStatus ACS,
             rhnActionPackage AP,
             rhnServerPackage SP,
             rhnPackageName PN,
             rhnServerAction SA
      WHERE  SA.server_id = :sid
      AND    SP.server_id = SA.server_id
      AND    PN.id IN (%s)
      AND    SP.name_id = PN.id
      AND    AP.action_id = SA.action_id
      AND    AP.name_id = SP.name_id
      AND    AP.evr_id = SP.evr_id
      AND    ACS.id = SA.status
      ORDER BY SA.completion_time desc
   </elaborator>
</mode>

<mode name="patches_in_set" class="com.redhat.rhn.frontend.dto.PackageListItem">
  <query params="set_label, user_id">
SELECT PN.id || '|' || PE.id AS ID_COMBO,
       PN.name || '-' || PE.evr.as_vre_simple() AS NVRE,
       PN.name AS name,
       PN.id AS NAME_ID,
       PE.id AS EVR_ID,
       nvl( (select spt.name
               from rhnSolarisPatchType spt,
                    rhnSolarisPatch RSP,
                    rhnPackage p
              where RSP.package_id = p.id
              and P.name_id = PN.id
                and P.evr_id = PE.id
                and RSP.patch_type = spt.id),
                'unknown') as PATCH_TYPE
    FROM  rhnPackageName PN, rhnPackageEVR PE, rhnSet S
   WHERE  S.label = :set_label
     AND  S.user_id = :user_id
     AND  S.element = PN.id
     AND  S.element_two = PE.id
 ORDER BY UPPER(NVRE)
  </query>
</mode>

<mode name="system_solaris_package_list" class="com.redhat.rhn.frontend.dto.PackageListItem">
  <query params="sid">
SELECT  PN.id || '|' || PE.id AS ID_COMBO,
        PN.name || '-' || PE.evr.as_vre_simple() AS NVRE,
        PN.name AS name,
        PE.version,
        PE.release,
        PE.epoch,
        PN.id AS NAME_ID,
        PE.id AS EVR_ID,
        PA.LABEL as arch
  FROM  rhnServerPackage SP
  			INNER JOIN rhnPackageName PN ON SP.name_id = PN.id
  			INNER JOIN rhnPackageEVR PE ON SP.evr_id = PE.id
  			INNER JOIN rhnPackageArch PA ON PA.id = SP.package_arch_id
  			INNER JOIN rhnArchType AT ON AT.id = PA.arch_type_id
  WHERE  SP.server_id = :sid
	   AND  AT.label = 'sysv-solaris'
ORDER BY UPPER(NVRE)
  </query>
</mode>

<mode name="system_available_patch_list" class="com.redhat.rhn.frontend.dto.PackageListItem">
  <query params="sid">
SELECT  pn.name AS NAME,
        pn.name || '-' || full_list.evr.version || '-' || full_list.evr.release || DECODE(full_list.evr.epoch, NULL, '', ':' || full_list.evr.epoch) AS NVRE,
        pn.id || '|' || lookup_evr(full_list.evr.epoch, full_list.evr.version, full_list.evr.release) AS ID_COMBO,
        full_list.id,
        full_list.PATCH_TYPE
  FROM  (
        SELECT  p.name_id name_id, max(pe.evr) evr, p.id, pt.name AS PATCH_TYPE
          FROM  rhnPackageEVR PE, rhnPackage P,
                 rhnChannelPackage CP, rhnServerChannel SC, rhnSolarisPatch SSP, rhnSolarisPatchType PT
         WHERE  sc.server_id = :sid
           AND  sc.channel_id = cp.channel_id
           AND  cp.package_id = p.id
           AND  ssp.package_id = p.id
           AND  p.evr_id = pe.id
           AND  pt.id = ssp.patch_type
      GROUP BY  p.name_id, p.id, pt.name
      ) full_list,
      rhnPackageName pn
 WHERE full_list.name_id = pn.id
   AND EXISTS (SELECT 1
            FROM rhnPackageNEVRA PNEVRA,
                 rhnSolarisPatchPackages SPP,
                 rhnServerPackage SP
          WHERE SP.server_id = :sid
            AND SPP.patch_id = full_list.id
            AND PNEVRA.id = SPP.package_nevra_id
            AND PNEVRA.name_id = SP.name_id
            AND ((PNEVRA.package_arch_id IS NULL AND SP.package_arch_id IS NULL) OR PNEVRA.package_arch_id = SP.package_arch_id)
            AND NOT EXISTS (SELECT 1
                            FROM rhnSolarisPatchedPackage SPdP
                            WHERE SPdP.server_id = :sid
                            AND SPdP.patch_id = full_list.id
                            AND SPdP.package_nevra_id = PNEVRA.id))
ORDER BY  UPPER(NVRE)
  </query>
  <elaborator params="sid" multiple="t">
SELECT DISTINCT PN.name AS NAME,
       PN.name || '-' || PE.evr.as_vre_simple() AS ELAB_NVRE,
       PN.id || '|' || PE.id AS ELAB_ID_COMBO,
       SPP.patch_id as ID
  FROM rhnPackage P,
       rhnPackageName PN,
       rhnPackageEVR PE,
       rhnPackageArch PA,
       rhnServerPackage SP,
       rhnPackageNEVRA PNEVRA,
       rhnServer S,
       rhnSolarisPatchPackages SPP
 WHERE SPP.patch_id IN (%s)
   AND S.id = :sid
   AND PNEVRA.id = SPP.package_nevra_id
   AND NOT EXISTS (SELECT 1
                     FROM rhnSolarisPatchedPackage SPdP
                    WHERE SPdP.server_id = :sid
                      AND SPdP.patch_id = SPP.patch_id
                      AND SPdP.package_nevra_id = PNEVRA.id)
   AND SP.server_id = S.id
   AND SP.name_id = PNEVRA.name_id
   AND SP.evr_id = PNEVRA.evr_id
   AND PN.id = PNEVRA.name_id
   AND PE.id = PNEVRA.evr_id
   AND P.name_id = SP.name_id
   AND p.evr_id = SP.evr_id
 ORDER BY PN.name
  </elaborator>
</mode>

<mode name="system_available_solaris_package_list" class="com.redhat.rhn.frontend.dto.PackageListItem">
  <query params="sid">
SELECT  pn.name AS NAME,
        pn.name || '-' || full_list.evr.version || '-' || full_list.evr.release || DECODE(full_list.evr.epoch, NULL, '', ':' || full_list.evr.epoch) AS NVRE,
        pn.id || '|' || lookup_evr(full_list.evr.epoch, full_list.evr.version, full_list.evr.release) AS ID_COMBO,
        pa.name as ARCH
  FROM  (
         SELECT  p.name_id name_id, max(pe.evr) evr
           FROM  rhnPackageEVR PE, rhnPackage P,
                 rhnChannelPackage CP, rhnServerChannel SC, rhnSolarisPackage SSP
          WHERE  sc.server_id = :sid
            AND  sc.channel_id = cp.channel_id
            AND  cp.package_id = p.id
            AND  ssp.package_id = p.id
            AND  p.evr_id = pe.id
       GROUP BY  p.name_id
       ) full_list,
       rhnPackageName pn
     INNER JOIN rhnPackage PKG ON pkg.name_id = pn.id
     INNER JOIN rhnPackageArch PA ON pa.id = pkg.package_arch_id
 WHERE  full_list.name_id = pn.id
   AND  full_list.name_id NOT IN (SELECT SP.name_id FROM rhnServerPackage SP WHERE SP.server_id = :sid)
ORDER BY  UPPER(pn.name)
  </query>
</mode>

<mode name="system_available_solaris_patchset_list" class="com.redhat.rhn.frontend.dto.SolarisPatchSet">
  <query params="sid">
  SELECT P.id,
         PN.name,
         SPS.set_date
    FROM rhnPackageName PN,
         rhnPackage P,
         rhnSolarisPatchSet SPS,
         rhnChannelPackage CP,
         rhnServerChannel SC
   WHERE SC.server_id = :sid
     AND CP.channel_id = SC.channel_id
     AND SPS.package_id = CP.package_id
     AND P.id = SPS.package_id
     AND PN.id = P.name_id
  </query>
  <elaborator params="sid" multiple="t">
SELECT P.id,
       NVL(SA.completion_time,
           NVL(SA.pickup_time,
               SA.created)) AS TIMESTAMP,
       ACS.name AS ACTION_STATUS
  FROM rhnActionStatus ACS,
       rhnActionPackage AP,
       rhnPackage P,
       rhnServerAction SA
 WHERE SA.server_id = :sid
   AND P.id IN (%s)
   AND AP.action_id = SA.action_id
   AND AP.name_id = P.name_id
   AND AP.evr_id = P.evr_id
   AND ACS.id = SA.status
ORDER BY SA.completion_time desc, SA.pickup_time desc, SA.created desc
  </elaborator>
</mode>

<mode name="package_available_to_user">
  <query params="pid, org_id">
SELECT 1
  FROM rhnPackage P
 WHERE p.id = :pid
   AND (   P.org_id = :org_id
        OR EXISTS (SELECT 1
                     FROM rhnOrgChannelTreeView CT inner join rhnChannelPackage CP on CT.id = CP.channel_id
                    WHERE CT.org_id = :org_id
                      AND CP.package_id = P.id)
        OR EXISTS (SELECT 1
                     FROM rhnSharedChannelTreeView CT inner join rhnChannelPackage CP on CT.id = CP.channel_id
                    WHERE CT.org_id = :org_id
                      AND CP.package_id = P.id)
       )
  </query>
</mode>

<mode name="system_upgradable_solaris_package_list" class="com.redhat.rhn.frontend.dto.UpgradablePackageListItem">
  <query params="sid">
SELECT  P.id AS id,
        PN.name AS name,
        pn.id || '|' || lookup_evr(full_list.evr.epoch, full_list.evr.version, full_list.evr.release) AS id_combo
  FROM  rhnPackage P,
        rhnSolarisPackage SP,
        rhnPackageName PN,
        (
         SELECT  SOP.package_name_id AS name_id, MAX(PE.evr) evr
           FROM  rhnPackageEVR PE, rhnServerOutdatedPackages SOP
          WHERE  SOP.server_id = :sid
            AND  SOP.package_evr_id = PE.id
       GROUP BY  SOP.package_name_id
         ) full_list
 WHERE  full_list.name_id = PN.id
   AND  PN.id = P.name_id
   AND  P.evr_id = lookup_evr(full_list.evr.epoch, full_list.evr.version, full_list.evr.release)
   AND  P.id = SP.package_id
ORDER BY  UPPER(PN.name)
  </query>
  <elaborator params="sid" multiple="t">
SELECT  P.id AS id,
        PN.id as name_id,
        pn.name ||'-'|| full_list.evr.version || '-' || full_list.evr.release || DECODE(full_list.evr.epoch, NULL, '', ':' || full_list.evr.epoch) AS nvre,
        lookup_evr(full_list.evr.epoch, full_list.evr.version, full_list.evr.release) AS evr_id,
        PN.name || '-' || SPE.evr.as_vre_simple() AS installed,
        full_list.server_id SERVER_ID,
        full_list.errata_id ERRATA_ID,
        full_list.errata_advisory ERRATA_ADVISORY,
        full_list.evr.epoch EPOCH,
        full_list.evr.version VERSION,
        full_list.evr.release RELEASE,
        E.advisory_type ERRATA_ADVISORY_TYPE
  FROM  rhnErrata E,
        rhnPackage P,
        rhnPackageName PN,
        rhnPackageEVR PE,
        rhnPackageEVR SPE,
        rhnServerPackage SP,
        (
         SELECT  SOP.package_name_id name_id, MAX(peD.evr) evr,
                 SOP.server_id server_id, SOP.errata_id errata_id,
                 SOP.errata_advisory errata_advisory
           FROM  rhnPackageEVR PED, rhnServerOutdatedPackages SOP
          WHERE  SOP.server_id = :sid
            AND  SOP.package_evr_id = PED.id
       GROUP BY  SOP.package_name_id, SOP.server_id, SOP.errata_id, SOP.errata_advisory
         ) full_list
 WHERE  P.id IN (%s)
   AND  P.name_id = PN.id
   AND  PN.id = full_list.name_id
   AND  full_list.errata_id = E.id (+)
   AND  PE.id = lookup_evr(full_list.evr.epoch, full_list.evr.version, full_list.evr.release)
   AND  SP.name_id = PN.id
   AND  SP.server_id = :sid
   AND  SPE.id = SP.evr_id
   AND  SPE.evr &lt; PE.evr
  </elaborator>
</mode>

<mode name="all_packages_in_channel_after" class="com.redhat.rhn.frontend.dto.PackageDto">
  <query params="cid, start_date_str">
SELECT
       P.id AS id,
       PN.name as name,
       NVL(PE.version, ' ') as version,
       NVL(PE.release, ' ') as release,
       NVL(PE.epoch, ' ') as epoch,
       PA.label AS arch_label,
       TO_CHAR(P.last_modified, 'YYYY-MM-DD HH24:MI:SS') AS last_modified
  FROM rhnPackageArch PA, rhnPackageName PN, rhnPackageEVR PE, rhnPackage P,
       rhnChannelPackage CP
 WHERE CP.channel_id = :cid
   AND CP.package_id = P.id
   AND P.name_id = PN.id
   AND P.evr_id = PE.id
   AND PA.id = P.package_arch_id
   AND P.last_modified &gt;= TO_DATE(:start_date_str, 'YYYY-MM-DD HH24:MI:SS')
ORDER BY UPPER(name)
  </query>
</mode>


<mode name="all_packages_in_channel_between" class="com.redhat.rhn.frontend.dto.PackageDto">
  <query params="cid, start_date_str, end_date_str">

SELECT
       P.id AS id,
       PN.name as name,
       NVL(PE.version, ' ') as version,
       NVL(PE.release, ' ') as release,
       NVL(PE.epoch, ' ') as epoch,
       PA.label AS arch_label,
       TO_CHAR(P.last_modified, 'YYYY-MM-DD HH24:MI:SS') AS last_modified
  FROM rhnPackageArch PA, rhnPackageName PN, rhnPackageEVR PE, rhnPackage P,
       rhnChannelPackage CP
 WHERE CP.channel_id = :cid
   AND CP.package_id = P.id
   AND P.name_id = PN.id
   AND P.evr_id = PE.id
   AND PA.id = P.package_arch_id
   AND P.last_modified &gt;= TO_DATE(:start_date_str, 'YYYY-MM-DD HH24:MI:SS')
      AND P.last_modified &lt;= TO_DATE(:end_date_str, 'YYYY-MM-DD HH24:MI:SS')
ORDER BY UPPER(name)
  </query>
</mode>

<mode name="all_packages_in_channel" class="com.redhat.rhn.frontend.dto.PackageDto">
  <query params="cid">
SELECT P.id AS id,
       PN.name as name,
       NVL(PE.version, ' ') as version,
       NVL(PE.release, ' ') as release,
       NVL(PE.epoch, ' ') as epoch,
       PA.label AS arch_label,
       TO_CHAR(P.last_modified, 'YYYY-MM-DD HH24:MI:SS') AS last_modified,
       CV.checksum as checksum,
       CV.checksum_type as checksum_type
  FROM rhnPackageArch PA, rhnPackageName PN, rhnPackageEVR PE, rhnPackage P,
       rhnChannelPackage CP, rhnChecksumView CV
 WHERE CP.channel_id = :cid
   AND CP.package_id = P.id
   AND P.name_id = PN.id
   AND P.evr_id = PE.id
   AND PA.id = P.package_arch_id
   AND P.checksum_id = CV.id
ORDER BY UPPER(name)
  </query>
</mode>

<mode name="all_packages_in_channel_after_by_date">
  <query params="cid, start_date_str">
SELECT
       P.id AS id,
       PN.name as name,
       NVL(PE.version, ' ') as version,
       NVL(PE.release, ' ') as release,
       NVL(PE.epoch, ' ') as epoch,
       PA.label AS arch_label,
       TO_CHAR(P.last_modified, 'YYYY-MM-DD HH24:MI:SS') AS last_modified
  FROM rhnPackageArch PA, rhnPackageName PN, rhnPackageEVR PE, rhnPackage P,
       rhnChannelPackage CP
 WHERE CP.channel_id = :cid
   AND CP.package_id = P.id
   AND P.name_id = PN.id
   AND P.evr_id = PE.id
   AND PA.id = P.package_arch_id
   AND P.last_modified &gt;= TO_DATE(:start_date_str, 'YYYY-MM-DD HH24:MI:SS')
ORDER BY last_modified
  </query>
</mode>


<mode name="all_packages_in_channel_between_by_date">
  <query params="cid, start_date_str, end_date_str">

SELECT
       P.id AS id,
       PN.name as name,
       NVL(PE.version, ' ') as version,
       NVL(PE.release, ' ') as release,
       NVL(PE.epoch, ' ') as epoch,
       PA.label AS arch_label,
       TO_CHAR(P.last_modified, 'YYYY-MM-DD HH24:MI:SS') AS last_modified
  FROM rhnPackageArch PA, rhnPackageName PN, rhnPackageEVR PE, rhnPackage P,
       rhnChannelPackage CP
 WHERE CP.channel_id = :cid
   AND CP.package_id = P.id
   AND P.name_id = PN.id
   AND P.evr_id = PE.id
   AND PA.id = P.package_arch_id
   AND P.last_modified &gt;= TO_DATE(:start_date_str, 'YYYY-MM-DD HH24:MI:SS')
      AND P.last_modified &lt;= TO_DATE(:end_date_str, 'YYYY-MM-DD HH24:MI:SS')
ORDER BY last_modified
  </query>
</mode>

<mode name="all_packages_in_channel_by_date">
  <query params="cid">
SELECT
       P.id AS id,
       PN.name as name,
       NVL(PE.version, ' ') as version,
       NVL(PE.release, ' ') as release,
       NVL(PE.epoch, ' ') as epoch,
       PA.label AS arch_label,
       TO_CHAR(P.last_modified, 'YYYY-MM-DD HH24:MI:SS') AS last_modified
  FROM rhnPackageArch PA, rhnPackageName PN, rhnPackageEVR PE, rhnPackage P,
       rhnChannelPackage CP
 WHERE CP.channel_id = :cid
   AND CP.package_id = P.id
   AND P.name_id = PN.id
   AND P.evr_id = PE.id
   AND PA.id = P.package_arch_id
ORDER BY last_modified
  </query>
</mode>

<mode name="possible_packages_for_pushing_into_channel" class="com.redhat.rhn.frontend.dto.PackageComparison">
  <query params="cid, eid">
SELECT P1.id,
       PN.name,
       PE2.evr.as_vre_simple() || '.' || PA2.label AS current_nvrea,
       PE1.evr.as_vre_simple() || '.' || PA1.label AS new_nvrea
FROM rhnPackage P1,
     rhnPackageEVR PE1,
     rhnPackageArch PA1,
     rhnChannelNewestPackage CNP,
     rhnPackageEVR PE2,
     rhnPackageArch PA2,
     rhnPackageName PN,
     rhnErrataPackage EP
WHERE EP.errata_id = :eid
  AND P1.id = EP.package_id
  AND CNP.channel_id = :cid
  AND P1.name_id = CNP.name_id
  AND p1.package_arch_id = CNP.package_arch_id
  AND PE1.id = P1.evr_id
  AND PA1.id = P1.package_arch_id
  AND PE2.id = CNP.evr_id
  AND PA2.id = CNP.package_arch_id
  AND PN.id = P1.name_id
  AND rpm.vercmp(PE1.epoch, PE1.version, PE1.release, PE2.epoch, PE2.version, PE2.release) > 0
  </query>
</mode>


<mode name="packages_in_errata_not_in_channel" class="com.redhat.rhn.frontend.dto.PackageComparison">
  <query params="cid, eid">
SELECT P.id,
       PN.name,
       NULL AS current_nvrea,
       PE1.evr.as_vre_simple() || '.' || PA.label AS new_nvrea
FROM rhnPackage P,
  rhnErrataPackage EP,
  rhnPackageEVR PE1,
  rhnPackageName PN,
  rhnChannelPackageArchCompat pac,
  rhnChannel c,
  rhnPackageArch PA
WHERE EP.errata_id = :eid
  AND EP.package_id = P.id
  AND PE1.id = P.evr_id
  AND PN.id = P.name_id
  AND PA.id = P.package_arch_id
  AND pac.channel_arch_id = c.channel_arch_id
  AND pac.package_arch_id = p.package_arch_id
  AND C.id = :cid
  AND P.id NOT IN (select package_id from rhnChannelPackage
                    where CHANNEL_ID = :cid)
  AND P.ID NOT IN (
    SELECT P1.id
    FROM rhnPackage P1,
         rhnPackageEVR PE1,
         rhnChannelNewestPackage CNP,
         rhnPackageEVR PE2,
         rhnPackageName PN,
         rhnErrataPackage EP
    WHERE EP.errata_id = :eid
      AND P1.id = EP.package_id
      AND CNP.channel_id = :cid
      AND P1.name_id = CNP.name_id
      AND p1.package_arch_id = CNP.package_arch_id
      AND PE1.id = P1.evr_id
      AND PE2.id = CNP.evr_id
      AND PN.id = P1.name_id
      AND rpm.vercmp(PE1.epoch, PE1.version, PE1.release, PE2.epoch, PE2.version, PE2.release) != 0)
  </query>
</mode>

<mode name="server_packages_needing_update">
  <query params="sid, name">
SELECT P.id, PE.epoch, PE.version, PE.release
  FROM rhnPackageEVR PE, rhnPackageName PN, rhnPackage P, rhnServerNeededPackageCache SNPC
 WHERE SNPC.server_id = :sid
   AND P.id = SNPC.package_id
   AND PN.id = P.name_id
   AND PN.name = :name
   AND PE.id = P.evr_id
  </query>
</mode>

<write-mode name="schedule_pkg_for_delete">
  <query params="path">
    INSERT INTO rhnPackageFileDeleteQueue
      VALUES (:path, sysdate)
  </query>
</write-mode>

<!-- Schedules the deletion of all packages found in the given RhnSet. The set must
     contain the package ID in the "element" of the set. -->
<write-mode name="schedule_pkg_for_delete_from_set">
  <query params="set_label">
    INSERT INTO rhnPackageFileDeleteQueue (path, created)
      (SELECT p.path, sysdate
         FROM rhnPackage p, rhnSet s
        WHERE p.id = s.element
          AND s.label = :set_label
      )
  </query>
</write-mode>

<!-- Deletes packages found in the given RhnSet. The set must contain the package ID in
     the "element" of the set. -->
<write-mode name="delete_packages_from_set">
   <query params="set_label">
      DELETE FROM rhnPackage p
            WHERE p.id IN (
                  SELECT s.element
                    FROM rhnSet s
                   WHERE s.label = :set_label
                  )
   </query>
</write-mode>

<write-mode name="insert_channel_packages_in_set">
  <query params="cid, set_label, user_id">
    INSERT ALL INTO rhnChannelPackage(channel_id, package_id) VALUES (:cid, pid)
    select element  as pid
    from rhnSet S
    	where S.user_id = :user_id and
    			S.label = :set_label
  </query>
</write-mode>


<mode name="packages_by_name">
<query params="package_name, org_id">
SELECT NVREA, PACKAGE_ID, CHANNEL_NAME, CHANNEL_ID
  FROM (SELECT DISTINCT
               PE.evr AS EVR,
               PN.name || '-' || PE.evr.as_vre_simple() || '.' || PA.label AS NVREA,
               C.name AS CHANNEL_NAME,
               P.ID AS PACKAGE_ID,
               C.id AS CHANNEL_ID
          FROM rhnPackageArch PA,
               rhnChannel C,
               rhnPackageName PN,
               rhnPackageEVR PE,
               rhnPackage P,
               rhnChannelPackage CP,
               rhnAvailableChannels AC
         WHERE AC.org_id = :org_id
           AND PN.name = :package_name
           AND PN.id = P.name_id
           AND PE.id = P.evr_id
           AND AC.channel_id = CP.channel_id
           AND AC.channel_arch_id IN (SELECT id FROM rhnChannelArch WHERE label IN (%s))
           AND P.id = CP.package_id
           AND C.id = AC.channel_id
           AND PA.id = P.package_arch_id
        )
ORDER BY CHANNEL_NAME DESC, EVR DESC

</query>
</mode>

<mode name="packages_by_name_smart">
<query params="package_name, org_id">
<!-- This uses an inline view to filter away the PE.evr since
     DBD Oracle can't handle an Oracle object in the return results of a
     query.
-->
<!-- AC.current_members > 0 is used here. -->
SELECT NVREA, PACKAGE_ID, CHANNEL_NAME, CHANNEL_ID
  FROM (SELECT DISTINCT
               PE.evr AS EVR,
               PN.name || '-' || PE.evr.as_vre_simple() || '.' || PA.label AS NVREA,
               C.name AS CHANNEL_NAME,
               P.ID AS PACKAGE_ID,
               C.id AS CHANNEL_ID
          FROM rhnPackageArch PA,
               rhnChannel C,
               rhnPackageName PN,
               rhnPackageEVR PE,
               rhnPackage P,
               rhnChannelPackage CP,
               rhnAvailableChannels AC
         WHERE AC.org_id = :org_id
           AND PN.name = :package_name
           AND PN.id = P.name_id
           AND PE.id = P.evr_id
           AND AC.channel_id = CP.channel_id
           AND AC.current_members > 0
           AND P.id = CP.package_id
           AND C.id = AC.channel_id
           AND PA.id = P.package_arch_id
        )
ORDER BY CHANNEL_NAME DESC, EVR DESC
</query>
</mode>

<mode name="packages_by_name_clabel">
<query params="package_name, org_id">
<!-- This uses an inline view to filter away the PE.evr since
     DBD Oracle can't handle an Oracle object in the return results of a
     query.
-->

SELECT NVREA, PACKAGE_ID, CHANNEL_NAME, CHANNEL_ID
  FROM (SELECT DISTINCT
               PE.evr AS EVR,
               PN.name || '-' || PE.evr.as_vre_simple() || '.' || PA.label AS NVREA,
               C.name AS CHANNEL_NAME,
               P.ID AS PACKAGE_ID,
               C.id AS CHANNEL_ID
          FROM rhnPackageArch PA,
               rhnChannel C,
               rhnPackageName PN,
               rhnPackageEVR PE,
               rhnPackage P,
               rhnChannelPackage CP,
               rhnAvailableChannels AC
         WHERE AC.org_id = :org_id
           AND PN.name = :package_name
           AND PN.id = P.name_id
           AND PE.id = P.evr_id
           AND AC.channel_id = CP.channel_id
           AND AC.channel_label = 'redhat-linux-i386-8.0'
           AND P.id = CP.package_id
           AND C.id = AC.channel_id
           AND PA.id = P.package_arch_id
        )
ORDER BY CHANNEL_NAME DESC, EVR DESC
</query>
</mode>

<mode name="packages_by_name_cid">
<query params="package_name, org_id, channel_id">
<!-- This uses an inline view to filter away the PE.evr since
     DBD Oracle can't handle an Oracle object in the return results of a
     query.
-->

SELECT NVREA, PACKAGE_ID, CHANNEL_NAME, CHANNEL_ID
  FROM (SELECT DISTINCT
               PE.evr AS EVR,
               PN.name || '-' || PE.evr.as_vre_simple() || '.' || PA.label AS NVREA,
               C.name AS CHANNEL_NAME,
               P.ID AS PACKAGE_ID,
               C.id AS CHANNEL_ID
          FROM rhnPackageArch PA,
               rhnChannel C,
               rhnPackageName PN,
               rhnPackageEVR PE,
               rhnPackage P,
               rhnChannelPackage CP,
               rhnAvailableChannels AC
         WHERE AC.org_id = :org_id
           AND PN.name = :package_name
           AND CP.channel_id = :channel_id
           AND PN.id = P.name_id
           AND PE.id = P.evr_id
           AND AC.channel_id = CP.channel_id
           AND P.id = CP.package_id
           AND C.id = AC.channel_id
           AND PA.id = P.package_arch_id
        )
ORDER BY CHANNEL_NAME DESC, EVR DESC
</query>
</mode>




<mode name="patchsets_in_channel" class="com.redhat.rhn.frontend.dto.PatchSetOverview">
  <query params="cid">
SELECT P.id AS ID,
       PN.name,
       PN.name || '-' || PE.evr.as_vre_simple() AS NVRE,
       P.summary,
       PA.label AS ARCH,
       PN.name || '-' || PE.evr.as_vre_simple() || '.' || PA.label AS NVREA,
       TO_CHAR(SP.set_date, 'YYYY-MM-DD') AS set_date
  FROM rhnPackageArch PA, rhnPackageName PN, rhnPackageEVR PE, rhnPackage P,
       rhnChannelPackage CP, rhnSolarisPatchSet SP
 WHERE CP.channel_id = :cid
   AND CP.package_id = P.id
   AND P.name_id = PN.id
   AND P.evr_id = PE.id
   AND PA.id = P.package_arch_id
   AND P.id = SP.package_id
ORDER BY UPPER(NVRE)
  </query>
</mode>

<mode name="packages_for_channel_from_channel" class="com.redhat.rhn.frontend.dto.PackageOverview">
  <query params="cid, scid">
SELECT distinct P.id AS ID,
       PN.name || '-' || PE.evr.as_vre_simple() || '.' || PA.label AS NVREA
  FROM rhnPackage P inner join
  	   rhnPackageArch PA on P.package_arch_id = PA.id inner join
	   rhnPackageName PN on P.name_id = PN.id inner join
	   rhnPackageEVR PE on P.evr_id = PE.id inner join
       rhnChannelPackage CP on CP.package_id = P.id  inner join
       rhnChannelPackageArchCompat CPAC on CPAC.package_arch_id = P.package_arch_id inner join
       rhnChannelArch CA2 on CPAC.channel_arch_id = CA2.id inner join
       rhnChannel C2 on C2.channel_arch_id = CA2.id
 WHERE  CP.channel_id = :scid and
		C2.id = :cid  and
		P.id not in (
			select CP2.package_id
            from rhnChannelPackage CP2
			where CP2.channel_id = :cid
		)
  </query>
    <elaborator name="package_details" />
</mode>

<mode name="custom_packages_for_channel" class="com.redhat.rhn.frontend.dto.PackageOverview">
  <query params="cid, org_id">
SELECT distinct P.id AS ID,
       PN.name || '-' || PE.evr.as_vre_simple() || '.' || PA.label AS NVREA
  FROM rhnPackage P inner join
  	   rhnPackageArch PA on P.package_arch_id = PA.id inner join
	   rhnPackageName PN on P.name_id = PN.id inner join
	   rhnPackageEVR PE on P.evr_id = PE.id
 WHERE  P.org_id = :org_id and
 		not exists (	
			select P.id
            from rhnChannelPackage CP2 inner join
             rhnPackage P2 on CP2.package_id = P2.id
 			where CP2.channel_id = :cid and
 				P2.name_id = PN.id and
 				P2.evr_id = PE.id and
 				P2.package_arch_id = PA.id
 		)
  </query>
    <elaborator name="package_details" />
</mode>


<mode name="orphan_packages_for_channel" class="com.redhat.rhn.frontend.dto.PackageOverview">
  <query params="cid, org_id">
SELECT distinct P.id AS ID,
       PN.name || '-' || PE.evr.as_vre_simple() || '.' || PA.label AS NVREA
  FROM rhnPackage P inner join
  	   rhnPackageArch PA on P.package_arch_id = PA.id inner join
	   rhnPackageName PN on P.name_id = PN.id inner join
  	   rhnPackageEVR PE on P.evr_id = PE.id left join
  	   rhnChannelPackage CP on P.id = CP.package_id
 WHERE  (P.org_id = :org_id) and
 		CP.channel_id is null and
 		not exists (	
			select P.id
            from rhnChannelPackage CP2 inner join
             rhnPackage P2 on CP2.package_id = P2.id
 			where CP2.channel_id = :cid and
 				P2.name_id = PN.id and
 				P2.evr_id = PE.id and
 				P2.package_arch_id = PA.id
 		)
  </query>
    <elaborator name="package_details" />
</mode>


<mode name="orphan_packages" class="com.redhat.rhn.frontend.dto.PackageOverview">
  <query params="org_id">
SELECT distinct P.id AS ID,
       PN.name || '-' || PE.evr.as_vre_simple() || '.' || PA.label AS NVREA
  FROM rhnPackage P inner join
	   rhnPackageArch PA on P.package_arch_id = PA.id inner join
	   rhnPackageName PN on P.name_id = PN.id inner join
	   rhnPackageEVR PE on P.evr_id = PE.id left join
	   rhnChannelPackage CP on CP.package_id = P.id
 WHERE  P.org_id = :org_id and
		CP.package_id is null
  </query>
    <elaborator name="package_details" />
</mode>


<mode name="all_custom_packages" class="com.redhat.rhn.frontend.dto.PackageOverview">
  <query params="org_id">
SELECT distinct P.id AS ID,
       PN.name || '-' || PE.evr.as_vre_simple() || '.' || PA.label AS NVREA
  FROM rhnPackage P inner join
	   rhnPackageArch PA on P.package_arch_id = PA.id inner join
	   rhnPackageName PN on P.name_id = PN.id inner join
	   rhnPackageEVR PE on P.evr_id = PE.id
 WHERE  P.org_id = :org_id
  </query>
    <elaborator name="package_details" />
    <elaborator name="package_channels" />
</mode>


<mode name="custom_package_in_channel" class="com.redhat.rhn.frontend.dto.PackageOverview">
  <query params="cid, org_id">
SELECT distinct P.id AS ID,
       PN.name || '-' || PE.evr.as_vre_simple() || '.' || PA.label AS NVREA
  FROM rhnPackage P inner join
	   rhnPackageArch PA on P.package_arch_id = PA.id inner join
	   rhnPackageName PN on P.name_id = PN.id inner join
	   rhnPackageEVR PE on P.evr_id = PE.id left join
	   rhnChannelPackage CP on P.id = CP.package_id
 WHERE  (P.org_id = :org_id) and
		CP.channel_id = :cid
  </query>
    <elaborator name="package_details" />
</mode>

<write-mode name="cleanup_needed_package_cache">
  <query params="pid">
    DELETE from
    rhnServerNeededCache r
    WHERE r.package_id = :pid
  </query>
</write-mode>

<!-- Runs the cache cleanup for all packages in an RhnSet. The package ID must be in
     "element" of the set. -->
<write-mode name="cleanup_needed_package_cache_from_set">
  <query params="set_label">
    DELETE FROM rhnServerNeededCache r
          WHERE r.package_id IN
                (SELECT element
                   FROM rhnSet s
                  WHERE s.label = :set_label)

  </query>
</write-mode>

<write-mode name="cleanup_package_files_from_set">
  <query params="set_label">
    DELETE FROM rhnPackageFile r
          WHERE r.package_id IN
                (SELECT element
                   FROM rhnSet s
                  WHERE s.label = :set_label)
  </query>
</write-mode>


<write-mode name="cleanup_package_changelog_from_set">
  <query params="set_label">
    DELETE FROM rhnPackageChangeLog r
          WHERE r.package_id IN
                (SELECT element
                   FROM rhnSet s
                  WHERE s.label = :set_label)
  </query>
</write-mode>


<mode name="guestimate_package_by_channel" >
  <query params="cid, nameId, evrId">
	SELECT P.id
	  FROM rhnPackage P,
	       rhnChannelPackage CP
	 WHERE CP.channel_id = :cid
	   AND P.id = CP.package_id
	   AND P.name_id = :nameId
	   AND P.evr_id = :evrId
	ORDER BY P.package_arch_id
  </query>
</mode>

<mode name="guestimate_package_by_system" >
  <query params="sid, nameId, evrId">
SELECT P.id
  FROM
       rhnServerPackageArchCompat SPAC,
       rhnServer S,
       rhnServerChannel SC,
       rhnChannelPackage CP,
       rhnPackage P
 WHERE S.id = :sid
   AND P.name_id = :nameId
   AND P.evr_id = :evrId
   AND p.id = cp.package_id
   and cp.channel_id = sc.channel_id
   AND SC.server_id = S.id
   AND S.server_arch_id = SPAC.server_arch_id
   AND SPAC.package_arch_id = P.package_arch_id
ORDER BY P.package_arch_id DESC
  </query>
</mode>

<mode name="guestimate_package_by_system_arch" >
  <query params="sid, nameId, evrId, archId">
SELECT P.id
  FROM
       rhnServerPackageArchCompat SPAC,
       rhnServer S,
       rhnServerChannel SC,
       rhnChannelPackage CP,
       rhnPackage P
 WHERE S.id = :sid
   AND P.name_id = :nameId
   AND P.evr_id = :evrId
   AND P.package_arch_id = :archId
   AND p.id = cp.package_id
   and cp.channel_id = sc.channel_id
   AND SC.server_id = S.id
   AND S.server_arch_id = SPAC.server_arch_id
   AND SPAC.package_arch_id = P.package_arch_id
ORDER BY P.package_arch_id DESC
  </query>
</mode>

<!-- Deletes sources of all packages found in the given RhnSet. The set must
     contain the package ID in the "element" of the set. -->
<write-mode name="delete_package_sources_from_set">
   <query params="set_label">
      DELETE FROM rhnPackageSource ps
       WHERE ps.source_rpm_id IN (
             SELECT p.source_rpm_id
               FROM rhnPackage p, rhnSet s
              WHERE p.id = s.element
                AND s.label = :set_label
             )
   </query>

</write-mode>

<!-- Returns the set of channels that any of the packages in the given set belong to.
     The set must contain the package ID in the "element" of the set. -->
<mode name="determine_channels_for_packages_in_set">
   <query params="set_label">
      SELECT DISTINCT cp.channel_id
        FROM rhnChannelPackage cp, rhnSet s
       WHERE cp.package_id = s.element
         AND s.label = :set_label
   </query>
</mode>

<write-mode name="insert_primary_xml">
   <query params="pid, xml">
	update rhnPackageRepodata
		set primary_xml = :xml
	where package_id = :pid
   </query>
</write-mode>

<write-mode name="insert_filelist_xml">
   <query params="pid, xml">
	update rhnPackageRepodata
		set filelist = :xml
	where package_id = :pid
   </query>
</write-mode>

<write-mode name="insert_other_xml">
   <query params="pid, xml">
	update rhnPackageRepodata
		set other = :xml
	where package_id = :pid
   </query>
</write-mode>

<write-mode name="create_repo_entrys">
   <query params="cid">
	insert into rhnPackageRepodata (package_id)
		(select cp.package_id as id from rhnChannelPackage cp left join rhnPackageRepoData rd on cp.package_id = rd.package_id
			where cp.channel_id = :cid
			  and rd.package_id is null)
   </query>
</write-mode>


<mode name="lookup_repodata" class="com.redhat.rhn.frontend.dto.PackageDto">
  <query params="pid">
SELECT
     P.package_id AS id, p.primary_xml as primary_xml, p.other as other_xml, p.filelist as filelist_xml
    from rhnPackageRepoData p
     where p.package_id = :pid
  </query>
</mode>

</datasource_modes>
